---
import { Image } from 'astro:assets';

interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  quality?: number;
  class?: string;
  loading?: 'lazy' | 'eager';
  sizes?: string;
  responsive?: boolean;
}

const {
  src,
  alt,
  width = 800,
  height = 600,
  quality = 80,
  class: className = '',
  loading = 'lazy',
  sizes = '(min-width: 1024px) 800px, (min-width: 768px) 600px, 100vw',
  responsive = true
} = Astro.props;

// Sanitizza il nome del file per essere compatibile con il sistema di ottimizzazione
const sanitizeFilename = (filename: string) => {
  // Estrai nome e estensione separatamente (come nello script)
  const lastDot = filename.lastIndexOf('.');
  const name = lastDot !== -1 ? filename.substring(0, lastDot) : filename;
  const ext = lastDot !== -1 ? filename.substring(lastDot).toLowerCase() : '';
  
  const sanitizedName = name
    .replace(/\s+/g, '-')           // Sostituisce spazi con trattini
    .replace(/[àáâäãå]/g, 'a')      // Sostituisce caratteri accentati
    .replace(/[èéêë]/g, 'e')
    .replace(/[ìíîï]/g, 'i')
    .replace(/[òóôöõø]/g, 'o')
    .replace(/[ùúûü]/g, 'u')
    .replace(/[ýÿ]/g, 'y')
    .replace(/[ñ]/g, 'n')
    .replace(/[ç]/g, 'c')
    .replace(/[^\w\-_.]/g, '')      // Rimuove tutti i caratteri non alfanumerici eccetto - _ .
    .replace(/[-_]+/g, '-')         // Sostituisce multipli - o _ con un singolo -
    .replace(/^-+|-+$/g, '');       // Rimuove - all'inizio e alla fine
  
  return sanitizedName + ext;
};

// Determina il percorso dell'immagine ottimizzata
const getOptimizedImagePath = (originalSrc: string, format: string) => {
  if (!originalSrc) return '';
  
  // Se l'immagine è già in uploads/, usa il percorso ottimizzato
  if (originalSrc.includes('/uploads/')) {
    // Estrai il percorso completo dall'URL
    const urlParts = originalSrc.split('/');
    const filename = urlParts[urlParts.length - 1];
    
    if (filename) {
      // Sanitizza il nome del file per trovare la versione ottimizzata
      const sanitizedFilename = sanitizeFilename(filename);
      // Estrai il nome senza estensione (tutto tranne l'ultima estensione)
      const lastDot = sanitizedFilename.lastIndexOf('.');
      const nameWithoutExt = lastDot !== -1 ? sanitizedFilename.substring(0, lastDot) : sanitizedFilename;
      
      // Controlla se l'immagine è in una sottocartella
      const uploadsIndex = urlParts.findIndex(part => part === 'uploads');
      if (uploadsIndex !== -1 && uploadsIndex < urlParts.length - 2) {
        // L'immagine è in una sottocartella (es: /uploads/Foto_maglie/IMG_001.jpeg)
        const subfolderPath = urlParts.slice(uploadsIndex + 1, -1).join('/'); // "Foto_maglie"
        const optimizedSubfolder = `${subfolderPath}_ottimizzate`; // "Foto_maglie_ottimizzate"
        return `/uploads/optimized/${optimizedSubfolder}/${nameWithoutExt}.${format}`;
      } else {
        // L'immagine è direttamente in uploads/ (comportamento esistente)
        return `/uploads/optimized/${nameWithoutExt}.${format}`;
      }
    }
  }
  
  return originalSrc;
};

const webpSrc = getOptimizedImagePath(src, 'webp');
const avifSrc = getOptimizedImagePath(src, 'avif');

// Genera srcset responsive per diverse risoluzioni
const generateSrcSet = (baseSrc: string, format: string) => {
  if (!responsive) return '';
  
  const sizes = [400, 600, 800, 1200];
  const optimizedBasePath = getOptimizedImagePath(baseSrc, format);
  
  return sizes.map(size => {
    // Per il responsive, usiamo lo stesso percorso ottimizzato per tutte le dimensioni
    // In futuro si potrebbe aggiungere supporto per diverse risoluzioni per file
    return `${optimizedBasePath} ${size}w`;
  }).join(', ');
};

// Debug: mostra i percorsi generati (solo in sviluppo)
if (import.meta.env.DEV) {
  console.log('🖼️ OptimizedImage Debug:');
  console.log('  Original:', src);
  console.log('  WebP:', webpSrc);
  console.log('  AVIF:', avifSrc);
  
  // Mostra se è una sottocartella
  if (src.includes('/uploads/') && src.split('/').length > 3) {
    const pathParts = src.split('/');
    const subfolderPath = pathParts.slice(pathParts.findIndex(p => p === 'uploads') + 1, -1).join('/');
    console.log('  📁 Subfolder detected:', subfolderPath);
    console.log('  📁 Optimized folder:', `${subfolderPath}_ottimizzate`);
  }
}

---

<picture class={className}>
  <!-- Formato AVIF (più moderno e compresso) -->
  {avifSrc && avifSrc !== src && (
    <source 
      srcset={responsive ? generateSrcSet(src, 'avif') : avifSrc}
      type="image/avif" 
      sizes={sizes}
    />
  )}
  
  <!-- Formato WebP (supporto ampio e buona compressione) -->
  {webpSrc && webpSrc !== src && (
    <source 
      srcset={responsive ? generateSrcSet(src, 'webp') : webpSrc}
      type="image/webp" 
      sizes={sizes}
    />
  )}
  
  <!-- Fallback: WebP se disponibile, altrimenti originale -->
  <img
    src={webpSrc && webpSrc !== src ? webpSrc : src}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    decoding="async"
    class="optimized-image"
    sizes={sizes}
  />
</picture>

<style>
  picture {
    width: 100%;
    height: 100%;
    display: block;
  }
  
  .optimized-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.3s ease;
  }
  
  .optimized-image[loading="lazy"] {
    opacity: 0;
    animation: fadeIn 0.5s ease forwards;
  }
  
  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }
</style>
